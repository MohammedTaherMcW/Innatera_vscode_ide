(()=>{"use strict";var e={980:e=>{e.exports=require("vscode")}},t={};function o(n){var s=t[n];if(void 0!==s)return s.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,o),i.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};(()=>{o.r(n),o.d(n,{activate:()=>V,deactivate:()=>B,extension:()=>F});const e=process.platform.startsWith("win"),t="darwin"==process.platform,s=["llvm-vs-code-extensions.vscode-clangd","vsciot-vscode.vscode-arduino","vscode-openapi"];var i=o(980),r=o.n(i);const a=require("Innatera-node-helpers"),c=require("platformio-vscode-debug"),l=require("os");var d=o.n(l);function h(e){for(;e.length;)e.pop().dispose()}async function m(e,t){const o=t.stack||t.toString(),n=`# Description of problem\n  Leave a comment...\n\n  BEFORE SUBMITTING, PLEASE SEARCH FOR DUPLICATES IN\n  - https://github.com/platformio/platformio-vscode-ide/issues?q=is%3Aissue+\n\n  # Configuration\n\n  VSCode: ${r().version}\n  PIO IDE: v${p()}\n  System: ${d().type()}, ${d().release()}, ${d().arch()}\n\n  # Exception\n  \`\`\`\n  ${o}\n  \`\`\`\n  `,s=a.misc.getErrorReportUrl(e,n);let i="Report a problem";s.includes("issues/new")||(i="Check available solutions"),await r().window.showErrorMessage(o.substring(0,700)+"...",i)===i&&r().commands.executeCommand("vscode.open",r().Uri.parse(s)),console.error(t)}function p(){return r().extensions.getExtension("platformio.platformio-ide").packageJSON.version}async function u(){const e=await a.core.getCorePythonCommandOutput(["-c","\nimport json\nfrom platformio.public import list_serial_ports\n\nprint(json.dumps(list_serial_ports()))\n    "]);return JSON.parse(e.trim()).map((e=>{for(const t of["description","hwid"])"n/a"===e[t]&&(e[t]=void 0);return e}))}const g=require("fs");var w=o.n(g);const f=require("path");var v=o.n(f);function C(e){try{return w().accessSync(v().join(e,"platformio.ini")),!0}catch(e){}return!1}function P(){return(r().workspace.workspaceFolders||[]).map((e=>e.uri.fsPath)).filter((e=>C(e)))}function T(){if(P().length<1)return;const e=r().window.activeTextEditor;if(!e)return;const t=e.document.uri;if("file"!==t.scheme)return;const o=r().workspace.getWorkspaceFolder(t);return o&&C(o.uri.fsPath)?o.uri.fsPath:void 0}function b(e,t){return(F.context.globalState.get("projects",{})[e]||{})[t]}function E(e,t,o){const n=F.context.globalState.get("projects",{});n[e]||(n[e]={}),n[e][t]=o;for(const e of Object.keys(n))C(e)||delete n[e];F.context.globalState.update("projects",n),F.context.globalState.update("lastProjectDir",e)}class S{static defaultStartUrl="/";constructor(){this.subscriptions=[],this._currentPanel=void 0,this._lastStartUrl=S.defaultStartUrl,this.subscriptions.push(r().workspace.onDidChangeWorkspaceFolders(this.disposePanel.bind(this)))}static async shutdownAllServers(){await a.home.shutdownServer(),await a.home.shutdownAllServers()}onPanelDisposed(){this._currentPanel=void 0}disposePanel(){this._currentPanel&&(this._currentPanel.dispose(),this._currentPanel=void 0)}dispose(){a.home.shutdownServer(),this.disposePanel(),h(this.subscriptions)}async toggle(e=S.defaultStartUrl){const t=r().window.activeTextEditor?r().window.activeTextEditor.viewColumn:void 0;try{if(this._currentPanel)return this._lastStartUrl!==e&&(this._currentPanel.webview.html=await this.getWebviewContent(e)),this._currentPanel.reveal(t)}catch(e){console.warn(e)}this._currentPanel=await this.newPanel(e)}async newPanel(e){const t=r().window.createWebviewPanel("pioHome",F.getEnterpriseSetting("pioHomeTitle","Innatera Home"),r().ViewColumn.One,{enableScripts:!0,retainContextWhenHidden:!0});this.subscriptions.push(t.onDidDispose(this.onPanelDisposed.bind(this))),t.iconPath=r().Uri.file(v().join(F.context.extensionPath,"assets","images","platformio-mini-logo.svg")),t.webview.html=this.getLoadingContent();try{t.webview.html=await this.getWebviewContent(e)}catch(e){e.toString().includes("Webview is disposed")||m("Start PIO Home Server",e)}return t}getTheme(){return((r().workspace.getConfiguration("workbench")||{}).colorTheme||"").toLowerCase().includes("light")?"light":"dark"}getLoadingContent(){return`<!DOCTYPE html>\n    <html lang="en">\n    <body style="background-color: ${"light"===this.getTheme()?"#FFF":"#1E1E1E"}">\n      <div style="padding: 15px;">Loading...</div>\n    </body>\n    </html>`}async getWebviewContent(e){this._lastStartUrl=e,await a.home.ensureServerStarted({port:F.getConfiguration("pioHomeServerHttpPort"),host:F.getConfiguration("pioHomeServerHttpHost"),onIDECommand:await this.onIDECommand.bind(this)});const o=this.getTheme(),n=`pioHomeIFrame-${r().env.sessionId}`;return`<!DOCTYPE html>\n      <html lang="en">\n      <head>${t?`\n<script>\n  function execCommand(data) {\n    document.getElementById('${n}').contentWindow.postMessage({'command': 'execCommand', 'data': data}, '*');\n  }\n  for (const command of ['copy', 'paste', 'cut']) {\n    document.addEventListener(command, (e) => {\n      execCommand(command);\n    });\n  }\n  document.addEventListener('selectstart', (e) => {\n    execCommand('selectAll');\n    e.preventDefault();\n  });\n  window.addEventListener('keydown', (e) => {\n    if (e.key === 'z' && e.metaKey) {\n      execCommand(e.shiftKey ? 'redo' : 'undo');\n    }\n  });\n  window.addEventListener('message', (e) => {\n    if (e.data.command === 'kbd-event') {\n      window.dispatchEvent(new KeyboardEvent('keydown', e.data.data));\n    }\n  });\n<\/script>\n  `:""}</head>\n      <body style="margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: ${"light"===o?"#FFF":"#1E1E1E"}">\n        <iframe id="${n}" src="${a.home.getFrontendUrl({start:e,theme:o,workspace:F.getEnterpriseSetting("defaultPIOHomeWorkspace")})}"\n          width="100%"\n          height="100%"\n          frameborder="0"\n          style="border: 0; left: 0; right: 0; bottom: 0; top: 0; position:absolute;" />\n      </body>\n      </html>\n    `}async onIDECommand(e,t){switch(e){case"open_project":return this.onOpenProjectCommand(t);case"open_text_document":return await this.onOpenTextDocumentCommand(t);case"get_pio_project_dirs":return this.onGetPIOProjectDirs()}}onOpenProjectCommand(e){return F.projectManager&&(E(r().Uri.file(e).fsPath,"selectedEnv",void 0),F.projectManager.switchToProject(r().Uri.file(e).fsPath,{force:!0})),this.disposePanel(),r().workspace.workspaceFolders?r().workspace.updateWorkspaceFolders(r().workspace.workspaceFolders.length,null,{uri:r().Uri.file(e)}):r().commands.executeCommand("vscode.openFolder",r().Uri.file(e)),r().commands.executeCommand("workbench.view.explorer"),!0}async onOpenTextDocumentCommand(e){const t=await r().window.showTextDocument(r().Uri.file(e.path)),o=new(r().Position)((e.line||1)-1,(e.column||1)-1);return t.selection=new(r().Selection)(o,o),t.revealRange(new(r().Range)(o,o),r().TextEditorRevealType.InCenter),!0}onGetPIOProjectDirs(){return P()}}const _=require("fs-plus");var I=o.n(_);class k{STATUS_TRY_AGAIN=0;STATUS_ABORT=1;STATUS_CUSTOMEXE=2;async prompt(){const e=await r().window.showInformationMessage("Innatera: Can not find working Python 3.6+ Interpreter. Please install the latest Python 3 and restart VSCode",{title:"Install Python",isCloseAffordance:!1},{title:"I have Python",isCloseAffordance:!1},{title:"Try again",isCloseAffordance:!1},{title:"Abort Innatera IDE Installation",isCloseAffordance:!0});let t,o={status:this.STATUS_TRY_AGAIN};switch(e?e.title:void 0){case"Install Python":r().commands.executeCommand("vscode.open",r().Uri.parse("https://docs.platformio.org/en/latest/faq/install-python.html"));break;case"I have Python":t=await r().window.showInputBox({prompt:"Please specify a full path to Python executable file",placeHolder:"Full path to python/python.exe",validateInput:e=>I().isFileSync(e)?null:"Invalid path to Python Interpreter"}),t&&(o={status:this.STATUS_CUSTOMEXE,pythonExecutable:t});break;case"Abort Innatera IDE Installation":o={status:this.STATUS_ABORT}}return o}}class y{LOCK_TIMEOUT=6e4;LOCK_KEY="installer-lock";constructor(e=!1){const t=r().workspace.getConfiguration("platformio-ide");this.stages=[new a.installer.PlatformIOCoreStage({getValue:e=>F.context.globalState.get(e),setValue:(e,t)=>F.context.globalState.update(e,t)},this.onDidStatusChange.bind(this),{pioCoreVersionSpec:">=6.1.6",useBuiltinPython:t.get("useBuiltinPython"),useBuiltinPIOCore:t.get("useBuiltinPIOCore"),useDevelopmentPIOCore:t.get("useDevelopmentPIOCore"),pythonPrompt:new k,disableAutoUpdates:e,predownloadedPackageDir:v().join(F.context.extensionPath,"assets","predownloaded")})]}onDidStatusChange(){this.locked()&&this.lock()}lock(){return F.context.globalState.update(this.LOCK_KEY,(new Date).getTime())}unlock(){return F.context.globalState.update(this.LOCK_KEY,void 0)}locked(){const e=F.context.globalState.get(this.LOCK_KEY);return!!e&&(new Date).getTime()-parseInt(e)<=this.LOCK_TIMEOUT}async check(){let e=!0;for(const t of this.stages)try{await t.check()||(e=!1)}catch(t){e=!1,console.warn(t)}return e}async install(e){const t=100/this.stages.length;await S.shutdownAllServers();for(const o of this.stages)await o.install(((o,n)=>{e.report({message:o,increment:t*(n/100)})}));e.report({message:"Finished! Please restart VSCode.",increment:100})}destroy(){return this.stages.map((e=>e.destroy()))}}class x{constructor(){this.version=F.context.extension.packageJSON.version,this._currentPanel=void 0,this.subscriptions=[r().commands.registerCommand("platformio-ide.showReleaseNotes",(()=>this.toggle()))];const e="showedReleaseNotesFor";F.context.globalState.get(e)!==this.version&&(F.context.globalState.update(e,this.version),this.toggle())}dispose(){h(this.subscriptions)}async toggle(){const e=r().window.activeTextEditor?r().window.activeTextEditor.viewColumn:void 0;try{if(this._currentPanel)return this._currentPanel.webview.html=await this.getWebviewContent(),this._currentPanel.reveal(e)}catch(e){console.warn(e)}this._currentPanel=await this.newPanel()}async newPanel(){const e=r().window.createWebviewPanel("pioReleaseNotes","Innatera IDE: Release Notes",r().ViewColumn.One,{enableScripts:!0,retainContextWhenHidden:!0});e.iconPath=r().Uri.file(v().join(F.context.extensionPath,"assets","images","platformio-mini-logo.svg")),e.onDidDispose((()=>this._currentPanel=void 0),void 0,this.subscriptions);const t=e.webview.asWebviewUri(r().Uri.file(v().join(F.context.extensionPath,"assets","images","platformio-logo.png")));return e.webview.html=await this.getWebviewContent(t),e}async getWebviewContent(e){const t=await this.readReleaseNotes();return`\n<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Innatera IDE: Release Notes</title>\n  <style>ul { padding-top: 5px; } li { padding-bottom: 4px; }</style>\n</head>\n<body>\n  <table border="0">\n  <tr>\n    <td><img src="${e}" width="28px" height="28px"></td>\n    <td style="padding-left: 10px"><h1>Innatera IDE Release Notes</h1></td>\n  </tr>\n  </table>\n  <div>\n    Welcome to the ${this.version} release of Innatera IDE.\n    There are many updates in this version that we hope you'll like.\n  </div>\n  <p>\n    <b>Release History</b>: Want to read release notes for the previous versions?\n    Please visit <a href="https://github.com/platformio/platformio-vscode-ide/blob/develop/CHANGELOG.md">PlatformIO IDE Changelog</a>\n    for more detailed information.\n  </p>\n  <p id="content">Loading...</p>\n  <h2>Stay in touch with us</h2>\n  <p>\n    Please follow us on <a href="https://www.linkedin.com/company/platformio">LinkedIn</a> and Twitter <a href="https://twitter.com/PlatformIO_Org">@PlatformIO_Org</a>\n    to keep up to date with the latest news, articles and tips!\n  </p>\n  <hr />\n  <p>\n    <b>Innatera Core</b>: If you would like to read the Innatera Core release notes,\n    go to the <a href="https://docs.platformio.org/en/latest/core/history.html">Release Notes</a> on <a href="https://docs.platformio.org/">docs.platformio.org</a>.\n  </p>\n  <textarea id="pioRNMarkdown" hidden="hidden">${t}</textarea>\n  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"><\/script>\n  <script>\n    document.getElementById('content').innerHTML =\n      marked.parse(document.getElementById('pioRNMarkdown').value);\n  <\/script>\n</body>\n</html>`}async readReleaseNotes(){const e=v().join(F.context.extensionPath,"CHANGELOG.md");try{const t=await g.promises.readFile(e,{encoding:"utf-8"}),o=t.indexOf("\n## ");return t.substring(o,t.indexOf("\n## ",o+3))}catch(e){return e.toString()}}}class O{constructor(){this._instance=void 0}new(){const e=Object.assign({},process.env);return process.env.PLATFORMIO_PATH&&(e.PATH=process.env.PLATFORMIO_PATH,e.Path=process.env.PLATFORMIO_PATH),r().window.createTerminal({name:"Innatera CLI",env:e})}sendText(e){this._instance&&void 0===this._instance.exitStatus||(this._instance=this.new()),this._instance.sendText(e),this._instance.show()}dispose(){this._instance&&this._instance.dispose(),this._instance=void 0}}class D{constructor(e,t,o){this.text=e,this.tooltip=t,this.commands=A.from(o)}createStatusBarItem(e={priority:0}){const t=r().window.createStatusBarItem(`pio-toolbar-${this.tooltip||this.text}`,r().StatusBarAlignment.Left,10+e.priority+1);return t.name=this.tooltip||"PlatformIO: Toolbar Item",t.text=this.text,t.tooltip=this.tooltip,t.command={title:this.tooltip,command:j.RUN_BUTTON_COMMANDS_ID,arguments:[this]},t}}class A{constructor(e,t=void 0){this.id=e,this.args=t}static from(e){return e?(Array.isArray(e)||(e=[e]),e.map((e=>"object"==typeof e?new A(e.id,e.args):new A(e)))):[]}}class j{static RUN_BUTTON_COMMANDS_ID="platformio-ide.runToolbarButtonCommand";constructor(e={filterCommands:void 0,ignoreCommands:void 0}){this.options=e,this.subscriptions=[],this.show()}dispose(){h(this.subscriptions)}static getButtons(){return(F.getConfiguration("toolbar")||[]).map((e=>new D(e.text,e.tooltip,A.from(e.commands))))}show(){this.refresh()}refresh(){this.dispose();const e=j.getButtons().filter((e=>(!this.options.filterCommands||e.commands.some((e=>this.options.filterCommands.includes(e.id))))&&(!this.options.ignoreCommands||!e.commands.some((e=>this.options.ignoreCommands.includes(e.id))))));e.forEach(((t,o)=>{const n=t.createStatusBarItem({priority:e.length-o});n.show(),this.subscriptions.push(n)})),this.subscriptions.push(r().workspace.onDidChangeConfiguration((e=>e.affectsConfiguration("platformio-ide.toolbar")?this.refresh():void 0)),r().commands.registerCommand(j.RUN_BUTTON_COMMANDS_ID,this.onButtonClick.bind(this)))}async onButtonClick(e){for(const t of e.commands){let e=t.args||[];Array.isArray(e)||(e=[e]);for(let t=0;t<e.length;t++)e[t]=await this._expandArgVariables(e[t]);await r().commands.executeCommand(t.id,...e)}}async _expandArgVariables(e){if(!e.includes("${"))return e;const t=e.match(/\$\{[^\}]+\}/g);for(const o of t)o.startsWith("${command:")&&(e=e.replace(o,await r().commands.executeCommand(o.substring(10,o.length-1))));return e}}class R{static DOCUMENT_SELECTOR={language:"ini"};SCOPE_PLATFORMIO="platformio";SCOPE_ENV="env";constructor(){this.diagnosticCollection=r().languages.createDiagnosticCollection("PlatformIO"),this.subscriptions=[this.diagnosticCollection,r().languages.registerHoverProvider(R.DOCUMENT_SELECTOR,{provideHover:async(e,t)=>await this.provideHover(e,t)}),r().languages.registerCompletionItemProvider(R.DOCUMENT_SELECTOR,{provideCompletionItems:async(e,t,o,n)=>await this.provideCompletionItems(e,t,o,n)}),r().workspace.onDidOpenTextDocument((e=>this.lintConfig(e.uri))),r().workspace.onDidSaveTextDocument((e=>this.lintConfig(e.uri)))],this._optionsCache=new Map,this._ports=void 0}dispose(){h(this.subscriptions),this._optionsCache.clear(),this.diagnosticCollection.clear()}async getOptions(e){const t=e.uri.fsPath;if(this._optionsCache.has(t))return this._optionsCache.get(t);const o=await a.core.getCorePythonCommandOutput(["-c","\nimport json\nfrom platformio.public import get_config_options_schema\n\nprint(json.dumps(get_config_options_schema()))\n  "],{projectDir:v().dirname(t)});return this._optionsCache.set(t,JSON.parse(o)),this._optionsCache.get(t)}renderOptionDocs(e){const t=[["Name",e.name],["Group",e.group],["Type",e.type],["Multiple",e.multiple?"yes":"no"]];if(e.sysenvvar&&t.push(["EnvironmentVariable",e.sysenvvar]),"choice"===e.type&&t.push(["Choices",e.choices.join(", ")]),void 0!==e.min&&t.push(["Minimum",e.min]),void 0!==e.max&&t.push(["Maximum",e.max]),null!==e.default||"boolean"===e.type){let o=e.default;"boolean"===e.type?o=e.default?"yes":"no":e.multiple&&Array.isArray(e.default)&&(o=e.default.join(", ")),t.push(["Default",o])}const o=new(r().MarkdownString);return o.appendCodeblock(t.map((([e,t])=>`${e} = ${t}`)).join("\n"),"ini"),o.appendMarkdown(`\n${e.description}\n\n[View documentation](https://docs.platformio.org/en/latest/projectconf/sections/${e.scope}/options/${e.group}/${e.name}.html?utm_source=vscode&utm_medium=completion)\n`),o}getScopeAt(e,t){const o=e.getText(new(r().Range)(new(r().Position)(0,0),t));for(const e of o.split("\n").reverse()){if(e.startsWith("[platformio]"))return this.SCOPE_PLATFORMIO;if(e.startsWith("[env]")||e.startsWith("[env:"))return this.SCOPE_ENV}}async getOptionAt(e,t){for(let o=t.line;o>0;o--){const t=e.lineAt(o).text;if(t.startsWith(" ")||t.startsWith("\t"))continue;const n=t.split("=")[0].trim();return(await this.getOptions(e)).find((e=>e.name===n))}}isOptionValueLocation(e,t){const o=e.lineAt(t.line).text,n=o.indexOf("=");return o.startsWith(" ")||o.startsWith("\t")||n>0&&t.character>n}async provideHover(e,t){const o=e.getText(e.getWordRangeAtPosition(t)),n=(await this.getOptions(e)).find((e=>e.name===o));return n?new(r().Hover)(this.renderOptionDocs(n)):this.providePackageHover(e,t)}async providePackageHover(e,t){const o=e.lineAt(t.line).text;let n;if(o.startsWith(" ")||o.startsWith("\t")?n=o:o.includes("=")&&(n=o.split("=",2)[1]),!n)return;const s=/^(([a-z\d_\-]+)\/)?([a-z\d\_\- ]+)/i.exec(n.trim());if(!s)return;const i=await this.getOptionAt(e,t);if(!["platform","lib_deps"].includes(i.name))return;const a=s[2],c=s[3],l=["https://registry.platformio.org"];if(a)l.push("platform"===i.name?"platforms":"libraries"),l.push(a.trim(),encodeURIComponent(c.trim()));else{const e=new URLSearchParams;e.set("t",i.group),e.set("q",`name:"${c.trim()}"`),l.push(`search?${e.toString()}`)}return new(r().Hover)(new(r().MarkdownString)(`[Open in Innatera Registry](${l.join("/")})`))}async provideCompletionItems(e,t,o,n,s=!1){if(!o.isCancellationRequested)return await(this.isOptionValueLocation(e,t)?this.provideCompletionValues(e,t,s):this.provideCompletionOptions(e,t,s))}async provideCompletionOptions(e,t,o=!1){const n=this.getScopeAt(e,t);if(n)return(await this.getOptions(e)).filter((e=>e.scope===n)).map((e=>{if(o)return new(r().InlineCompletionItem)(e.name);const t=new(r().CompletionItem)(e.name,r().CompletionItemKind.Field);return t.documentation=this.renderOptionDocs(e),t}))}async provideCompletionValues(e,t){const o=await this.getOptionAt(e,t);if(o){switch(o.name){case"upload_port":case"monitor_port":case"test_port":return await this.provideCompletionPorts();case"upload_speed":case"monitor_speed":case"test_speed":return await this.provideCompletionBaudrates(o)}return this.provideTypedCompletionValues(o)}}async provideTypedCompletionValues(e){const t=[];let o=e.default;switch(e.type){case"boolean":t.push("yes","no"),o=e.default?"yes":"no";break;case"choice":e.choices.forEach((e=>t.push(e)));break;case"integer range":for(let o=e.min;o<=e.max;o++)t.push(o)}return t.map((e=>{const t=new(r().CompletionItem)(e.toString(),r().CompletionItemKind.EnumMember);return t.preselect=o===e,t}))}createCustomCompletionValueItem(){const e=new(r().CompletionItem)("Custom",r().CompletionItemKind.Value);return e.insertText="",e.sortText="Z",e}async provideCompletionPorts(){this._ports||(this._ports=await u(),setTimeout((()=>this._ports=void 0),3e3));const e=(this._ports||[]).map((e=>{const t=new(r().CompletionItem)(e.port,r().CompletionItemKind.Value);return t.detail=e.description,t.documentation=e.hwid,t}));return e.push(this.createCustomCompletionValueItem()),e}async provideCompletionBaudrates(e){const t=[600,1200,2400,4800,9600,14400,19200,28800,38400,57600,115200,230400].map(((t,o)=>{const n=new(r().CompletionItem)(t.toString(),r().CompletionItemKind.Value);return n.sortText=String.fromCharCode(o+65),n.preselect=e.default===t,n}));return t.push(this.createCustomCompletionValueItem()),t}async lintConfig(e){if("platformio.ini"!==v().basename(e.fsPath))return;this.diagnosticCollection.clear();const t=v().dirname(e.fsPath),o=await a.core.getCorePythonCommandOutput(["-c","\nimport json\n\nfrom platformio.public import ProjectConfig\n\nprint(json.dumps(ProjectConfig.lint()))\n  "],{projectDir:t}),{errors:n,warnings:s}=JSON.parse(o);this.diagnosticCollection.set(e,s.map((e=>new(r().Diagnostic)(new(r().Range)(0,0,0,0),e,r().DiagnosticSeverity.Warning))));const i=new Map;return n.forEach((o=>{const n=o.source?r().Uri.file(v().isAbsolute(o.source)?o.source:v().join(t,o.source)):e,s=i.get(n.fsPath)||[];s.push(new(r().Diagnostic)(new(r().Range)(o?.lineno-1||0,0,o?.lineno||0,0),o.message,r().DiagnosticSeverity.Error)),i.set(n.fsPath,s)})),i.forEach(((e,t)=>this.diagnosticCollection.set(r().Uri.file(t),e))),!n.length}}class M{constructor(e,t,o,n=void 0,s=!1){this.id=e,this.envs=t,this.tasks=o,this.selectedEnv=n,this.multiEnvProject=this.envs.length>1,this.multiEnvExplorer=s}getEnvTasks(e=void 0,t=void 0){const o=e=>!t||e.group===t,n=this.tasks.filter((t=>o(t)&&t.coreEnv===e));return e&&n.push(...this.tasks.filter((t=>o(t)&&e!==M.DEFAULT_ENV_NAME&&!t.multienv))),n}getTreeItem(e){return e instanceof i.TreeItem?e:this.taskToTreeItem(e)}taskToTreeItem(e){const t=new i.TreeItem(e.name);return t.iconPath=new i.ThemeIcon("circle-outline"),t.tooltip=e.title,t.command={title:e.title,command:"platformio-ide._runProjectTask",arguments:[e]},!e.coreEnv&&e.multienv&&this.multiEnvProject&&(t.label+=" All"),t}getChildren(e){return e&&e.group?this.getEnvTasks(e.env,e.group):e?this.getEnvChildren(e.env):this.selectedEnv&&!this.multiEnvExplorer?this.getEnvChildren(this.selectedEnv):this.getRootChildren()}getRootChildren(){const e=[];for(const t of[...this.envs]){const o=new i.TreeItem(t,!t||t!==this.selectedEnv&&this.multiEnvProject?i.TreeItemCollapsibleState.Collapsed:i.TreeItemCollapsibleState.Expanded);o.id=`${this.id}-${t}`,o.env=t,o.iconPath=new i.ThemeIcon("root-folder"),e.push(o)}return e}getEnvChildren(e){const t=this.getEnvTasks(e);if(!t.length)return[new i.TreeItem("Loading...")];const o=t.filter((e=>!e.group));for(const n of this.getTaskGroups(t)){const t=new i.TreeItem(n,["Platform"].includes(n)?i.TreeItemCollapsibleState.Expanded:i.TreeItemCollapsibleState.Collapsed);t.env=e,t.group=n,t.iconPath=i.ThemeIcon.Folder,o.push(t)}return o}getTaskGroups(e){const t=[],o=e.filter((e=>e.group)).map((e=>e.group));o.includes("Platform")&&t.push("Platform");for(const e of o)t.includes(e)||t.push(e);return t}}class L{static defaultStartUrl="/";vscode=o(980);panel=void 0;constructor(){this.subscriptions=[],this._currentPanel=void 0,this._lastStartUrl=L.defaultStartUrl,this.subscriptions.push(r().workspace.onDidChangeWorkspaceFolders(this.disposePanel.bind(this)))}async toggle(e=L.defaultStartUrl){const t=r().window.activeTextEditor?r().window.activeTextEditor.viewColumn:void 0;try{if(this._currentPanel)return this._lastStartUrl!==e&&(this._currentPanel.webview.html=await this.getWebviewContent(e)),this._currentPanel.reveal(t)}catch(e){console.warn(e)}this._currentPanel=await this.newPanel(e)}static async shutdownAllServers(){await a.custom.shutdownServer(),await a.custom.shutdownAllServers()}disposePanel(){this._currentPanel&&(this._currentPanel.dispose(),this._currentPanel=void 0)}onPanelDisposed(){this._currentPanel=void 0}dispose(){a.custom.shutdownServer(),this.disposePanel(),h(this.subscriptions)}async newPanel(e){const t=r().window.createWebviewPanel("pioHome",F.getEnterpriseSetting("pioHomeTitle","Innatera Custom"),r().ViewColumn.One,{enableScripts:!0,retainContextWhenHidden:!0});this.subscriptions.push(t.onDidDispose(this.onPanelDisposed.bind(this))),t.iconPath=r().Uri.file(v().join(F.context.extensionPath,"assets","images","platformio-mini-logo.svg")),this.panel=t,t.webview.html=this.getLoadingContent();try{t.webview.html=await this.getWebviewContent(e)}catch(e){e.toString().includes("Webview is disposed")||m("Start PIO Home Server",e)}return t}getLoadingContent(){return`<!DOCTYPE html>\n    <html lang="en">\n    <body style="background-color: ${"light"===this.getTheme()?"#FFF":"#1E1E1E"}">\n      <div style="padding: 15px;">Loading...</div>\n    </body>\n    </html>`}getTheme(){return((r().workspace.getConfiguration("workbench")||{}).colorTheme||"").toLowerCase().includes("light")?"light":"dark"}async getWebviewContent(e){this._lastStartUrl=e,await a.custom.ensureServerStarted({port:F.getConfiguration("pioCustomServerHttpPort"),host:F.getConfiguration("pioCustomServerHttpHost"),onIDECommand:await this.onIDECommand.bind(this)});const o=this.getTheme(),n=`pioHomeIFrame-${r().env.sessionId}`;return`<!DOCTYPE html>\n      <html lang="en">\n      <head>${t?`\n      <script>\n        function execCommand(data) {\n          document.getElementById('${n}').contentWindow.postMessage({'command': 'execCommand', 'data': data}, '*');\n        }\n\n        for (const command of ['copy', 'paste', 'cut']) {\n          document.addEventListener(command, (e) => {\n            execCommand(command);\n          });\n        }\n\n        document.addEventListener('selectstart', (e) => {\n          execCommand('selectAll');\n          e.preventDefault();\n        });\n\n        window.addEventListener('keydown', (e) => {\n          if (e.key === 'z' && e.metaKey) {\n            execCommand(e.shiftKey ? 'redo' : 'undo');\n          }\n        });\n\n        window.addEventListener('message', (e) => {\n          if (e.data.command === 'kbd-event') {\n            window.dispatchEvent(new KeyboardEvent('keydown', e.data.data));\n          }\n        });\n      <\/script>\n    `:""}</head>\n      <body style="margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: ${"light"===o?"#FFF":"#1E1E1E"}">\n        <iframe id="${n}" src="${a.custom.getFrontendUrl({start:e,theme:o,workspace:F.getEnterpriseSetting("defaultPIOHomeWorkspace")})}"\n          width="100%"\n          height="100%"\n          frameborder="0"\n          style="border: 0; left: 0; right: 0; bottom: 0; top: 0; position:absolute;" />\n      </body>\n      </html>\n    `}async onIDECommand(e,t){if("get_custom_targets"===e)return this.onGetCustomTargets(t)}async runTask(t){try{for(let o of t){o=o.trim();const t=e?v().join(process.env.USERPROFILE,".platformio","penv","Scripts","platformio.exe"):v().join(process.env.HOME,".platformio","penv","bin","platformio"),n=new(r().ProcessExecution)(t,["run","--target",o]),s=new(r().Task)({type:"PlatformIO",target:o},r().TaskScope.Workspace,`Run PIO Target: ${o}`,"Custom Tasks",n),i=await r().tasks.executeTask(s);await new Promise(((e,t)=>{const o=r().tasks.onDidEndTaskProcess((r=>{r.execution===i&&(console.info(`Task ended with exit code: ${r.exitCode}`),o.dispose(),n.dispose(),0===r.exitCode?e():t(new Error(`Task ${s.name} failed with exit code ${r.exitCode}`)))})),n=r().tasks.onDidStartTaskProcess((e=>{e.execution===i&&console.info(`Task started: ${e.execution.task.name}`)}))}))}}catch(e){console.error("Error executing tasks:",e.message)}}async onGetCustomTargets(e){const t=e.split(",");this.runTask(t)}}class H{static PROVIDER_TYPE="PlatformIO";static TASKS_VIEW_ID="platformio-ide.projectTasks";static AUTO_REFRESH_DELAY=500;constructor(e,t){this.projectDir=e,this.projectObserver=t,this.subscriptions=[],this.PIOCustom=new L,this._sid=Math.random(),this._multienvTaskExplorer=!1,this._refreshTimeout=void 0,this._startedTask=void 0,this._tasksToRestore=[],this._sbPortSwitcher=void 0,this._customPort=b(e,"customPort"),this.refresh()}dispose(){h(this.subscriptions)}toggleMultiEnvExplorer(){this._multienvTaskExplorer=!this._multienvTaskExplorer,this.refresh({force:!0})}requestRefresh(){this._refreshTimeout&&clearTimeout(this._refreshTimeout),this._refreshTimeout=setTimeout(this.refresh.bind(this),H.AUTO_REFRESH_DELAY)}async refresh({force:e=!1}={}){this.dispose(),e&&(this.projectObserver.resetCache(),this._sid=Math.random());const t=(await this.projectObserver.getConfig()).envs(),o=[];for(const e of t)o.push(...await this.projectObserver.getLoadedEnvTasks(e)||[]);const n=r().window.createTreeView(H.TASKS_VIEW_ID,{treeDataProvider:new M(this._sid,t,o,this.projectObserver.getSelectedEnv(),this._multienvTaskExplorer),showCollapseAll:!0});this.subscriptions.push(n,n.onDidExpandElement((async({element:e})=>{e.env&&await this.onDidRequestEnvTasks(e.env)})),r().tasks.registerTaskProvider(H.PROVIDER_TYPE,{provideTasks:()=>o.map((e=>this.toVSCodeTask(e))),resolveTask:()=>{}}),r().tasks.onDidEndTaskProcess((e=>this.onDidEndTaskProcess(e)))),this.registerTaskBasedCommands(o),this.registerPortSwitcher(),r().commands.executeCommand("setContext","pioProjectTasksReady",!0),r().commands.executeCommand("setContext","pioMultiEnvProject",t.length>1)}async onDidRequestEnvTasks(e){if(!await this.projectObserver.getLoadedEnvTasks(e))return await this.projectObserver.loadEnvTasks(e),this.requestRefresh()}toVSCodeTask(t){const o=Object.assign({},process.env);process.env.PLATFORMIO_PATH&&(o.PATH=process.env.PLATFORMIO_PATH,o.Path=process.env.PLATFORMIO_PATH);const n=new(r().Task)({type:H.PROVIDER_TYPE,task:t.id},r().workspace.getWorkspaceFolder(r().Uri.file(this.projectDir)),t.id,H.PROVIDER_TYPE,new(r().ProcessExecution)(e?"platformio.exe":"platformio",t.getCoreArgs({port:this._customPort}),{cwd:this.projectDir,env:o}),"$platformio");return n.presentationOptions={panel:r().TaskPanelKind.Dedicated},t.isBuild()?n.group=r().TaskGroup.Build:t.isClean()?n.group=r().TaskGroup.Clean:t.isTest()&&(n.group=r().TaskGroup.Test),n}runTask(e){this._autoCloseSerialMonitor(e),r().commands.executeCommand("workbench.action.tasks.runTask",`${H.PROVIDER_TYPE}: ${e.id}`)}async _autoCloseSerialMonitor(e){this._startedTask=e,this._tasksToRestore=[],[F.getConfiguration("autoCloseSerialMonitor"),["upload","test"].some((e=>this.getTaskArgs(this._startedTask).includes(e)))].every((e=>e))&&r().tasks.taskExecutions.forEach((e=>{const t=this.areTasksEqual(this._startedTask,e.task);[e.task.definition.type!==H.PROVIDER_TYPE,!this.getTaskArgs(e.task).includes("monitor"),this.isMonitorAndUploadTask(e.task)&&!t].some((e=>e))||(t||this._tasksToRestore.push(e.task),e.terminate())}))}onDidEndTaskProcess(e){[!this._startedTask,!this.areTasksEqual(this._startedTask,e.execution.task),0!==e.exitCode,!this._tasksToRestore.length].some((e=>e))||(this._startedTask=void 0,setTimeout((()=>{for(;this._tasksToRestore.length;)r().tasks.executeTask(this._tasksToRestore.pop())}),parseInt(F.getConfiguration("reopenSerialMonitorDelay"))))}getTaskArgs(e){return e.args||e.execution.args}isMonitorAndUploadTask(e){const t=this.getTaskArgs(e);return["--target","upload","monitor"].every((e=>t.includes(e)))}areTasksEqual(e,t){if(!e||!t)return e===t;const o=this.getTaskArgs(e),n=this.getTaskArgs(t);return o.length===n.length&&o.every(((e,t)=>e===n[t]))}registerTaskBasedCommands(e){const t=t=>{const o=e.filter((e=>e.name===t));this.runTask(o[0])};this.subscriptions.push(r().commands.registerCommand("platformio-ide.build",(()=>t("BUILD"))),r().commands.registerCommand("platformio-ide.upload",(()=>t("Upload"))),r().commands.registerCommand("platformio-ide.uploadAndMonitor",(()=>t("Upload and Monitor"))),r().commands.registerCommand("platformio-ide.clean",(()=>t("Clean"))),r().commands.registerCommand("platformio-ide.test",(()=>t("Test"))),r().commands.registerCommand("platformio-ide.serialMonitor",(()=>t("Monitor"))),r().commands.registerCommand("platformio-ide.custom",(e=>this.PIOCustom.toggle(e))))}registerPortSwitcher(){this._sbPortSwitcher=r().window.createStatusBarItem("pio-port-switcher",r().StatusBarAlignment.Left,10),this._sbPortSwitcher.name="Innatera: Port Switcher",this._sbPortSwitcher.tooltip="Set upload/monitor/test port",this._sbPortSwitcher.command="platformio-ide.setProjectPort",this.switchPort(this._customPort),this.subscriptions.push(this._sbPortSwitcher,r().commands.registerCommand("platformio-ide.setProjectPort",(()=>this.pickProjectPort())))}async pickProjectPort(){const e=await u(),t=await r().window.showQuickPick([{label:"Auto"},...e.map((e=>({label:e.port,description:[e.description,e.hwid].filter((e=>!!e)).join(" | ")}))),{label:"Custom..."}],{matchOnDescription:!0});if(t)if("Custom..."===t.label){const e=await r().window.showInputBox({title:"Enter custom upload/monitor/test port",placeHolder:"Examples: COM3, /dev/ttyUSB*, 192.168.0.13, /media/disk"});if(!e)return;this.switchPort(e.trim())}else this.switchPort("Auto"!==t.label?t.label:void 0)}switchPort(e=void 0){E(this.projectDir,"customPort",e),this._customPort=e,this._sbPortSwitcher.text=`$(plug) ${this._customPort?v().basename(this._customPort):"Auto"}`,this._sbPortSwitcher.show()}}class U{constructor(e){this.projectDir=e,this.controller=r().tests.createTestController("platformio-tests","PlatformIO Tests"),this.subscriptions=[this.controller],this.controller.refreshHandler=this.refreshHandler.bind(this),this.controller.resolveHandler=this.resolveHandler.bind(this),this.controller.createRunProfile("Run Tests",r().TestRunProfileKind.Run,this.runHandler.bind(this),!0)}dispose(){h(this.subscriptions)}async runCoreTestCommand(e){const t=v().join(a.core.getTmpDir(),`test-list-${Math.round(1e5*Math.random())}.json`);let o,n=new Error;try{const n=Object.assign({},process.env);n.PLATFORMIO_FORCE_ANSI="true",o=await a.core.getPIOCommandOutput(["test",...e,"--json-output-path",t],{projectDir:this.projectDir,runInQueue:!0,spawnOptions:{env:n}})}catch(e){n=e}try{await g.promises.access(t)}catch(e){throw n}const s=await a.misc.loadJSON(t);return await g.promises.unlink(t),[s,o||n.toString()]}async refreshHandler(){this.controller.items.replace([]),await this.resolveTestSuites()}async resolveHandler(e){e?console.warn("Not Implemented"):await this.resolveTestSuites()}async resolveTestSuites(){try{const[e]=await this.runCoreTestCommand(["--list-tests"]);e.test_suites.reduce(((e,t)=>e.set(t.env_name,[...e.get(t.env_name)||[],t])),new Map).forEach(((e,t)=>{const o=this.controller.createTestItem(`env:${t}`,t);o.children.replace(e.map((e=>this.controller.createTestItem(`suite:${t}/${e.test_name}`,e.test_name,e.test_dir?r().Uri.file(e.test_dir):void 0)))),this.controller.items.add(o)}))}catch(e){console.error(e);const t=this.controller.createTestItem("error","Error (expand for details)");t.error=e.toString(),this.controller.items.add(t)}}extractTestSuites(e){return e.id.startsWith("suite:")?[e]:e.id.startsWith("case:")?[e.parent]:e.id.startsWith("env:")?e.children:[]}async runHandler(e,t){const o=this.controller.createTestRun(e),n=[],s=[];for(e.include?e.include.forEach((e=>this.extractTestSuites(e).forEach((e=>n.includes(e)?void 0:n.push(e))))):this.controller.items.forEach((e=>e.children.forEach((e=>n.push(e))))),e.exclude&&e.exclude.forEach((e=>this.extractTestSuites(e).forEach((e=>s.push(e)))));n.length>0&&!t.isCancellationRequested;){const e=n.pop();s.includes(e)?o.skipped(e):await this._runTestSuite(o,e)}o.end()}async _runTestSuite(e,t){const o=t.parent.label,n=t.label,s=Date.now();e.started(t);try{const[i,a]=await this.runCoreTestCommand(["--environment",o,"--filter",n]);process.chdir(i.project_dir);const c=i.test_suites.find((e=>e.env_name===o&&e.test_name===n));switch(c.status){case"SKIPPED":e.skipped(t);break;case"ERRORED":e.failed(t,new(r().TestMessage)(c.test_cases[0].exception),Date.now()-s);break;default:this._processTestSuiteResult(e,t,c,s)}e.appendOutput(a,void 0,t)}catch(o){e.appendOutput(o.toString(),void 0,t),e.failed(t,new(r().TestMessage)(o.toString()),Date.now()-s)}}async _processTestSuiteResult(e,t,o,n){const s=t.parent.label,i=t.label;t.children.replace([]),o.test_cases.forEach((o=>{const a=this.controller.createTestItem(`case:${s}/${i}/${o.name}`,o.name,o.source?r().Uri.file(v().resolve(o.source.file)):void 0);switch(o.source&&o.source.line&&(a.range=new(r().Range)(o.source.line-1,0,o.source.line-1,0)),t.children.add(a),o.status){case"SKIPPED":e.skipped(a);break;case"ERRORED":e.failed(a,new(r().TestMessage)(o.exception),Date.now()-n);break;case"FAILED":e.failed(a,new(r().TestMessage)(o.message),Date.now()-n);break;default:e.passed(a,Date.now()-n)}o.stdout&&e.appendOutput(o.stdout,a.uri?new(r().Location)(a.uri,a.range):void 0,a)}))}}class ${CONFIG_CHANGED_DELAY=3;constructor(){this._taskManager=void 0,this._sbEnvSwitcher=void 0,this._logOutputChannel=r().window.createOutputChannel("Innatera: Project Configuration"),this._configProvider=new R,this._configChangedTimeout=void 0,this._pool=new a.project.ProjectPool({ide:"vscode",api:{logOutputChannel:this._logOutputChannel,createFileSystemWatcher:r().workspace.createFileSystemWatcher,createDirSystemWatcher:e=>r().workspace.createFileSystemWatcher(v().join(e,"*")),withIndexRebuildingProgress:e=>r().window.withProgress({location:{viewId:r().ProgressLocation.Notification},title:"Innatera: Configuring project",cancellable:!0},(async(t,o)=>await e(((e,o=void 0)=>t.report({message:e,increment:o})),o))),withTasksLoadingProgress:e=>r().window.withProgress({location:{viewId:H.TASKS_VIEW_ID}},(async()=>await r().window.withProgress({location:{viewId:r().ProgressLocation.Window},title:"PlatformIO: Loading tasks..."},e))),onDidChangeProjectConfig:e=>{const t=v().dirname(e);this._configChangedTimeout&&(clearTimeout(this._configChangedTimeout),this._configChangedTimeout=void 0),this._configChangedTimeout=setTimeout((()=>this.switchToProject(t,{force:!0})),1e3*$.CONFIG_CHANGED_DELAY)},onDidNotifyError:m.bind(this)},settings:{autoPreloadEnvTasks:F.getConfiguration("autoPreloadEnvTasks"),autoRebuild:F.getConfiguration("autoRebuildAutocompleteIndex")}}),this.subscriptions=[this._pool,this._logOutputChannel,this._configProvider,r().window.onDidChangeActiveTextEditor((()=>{if(!F.getConfiguration("activateProjectOnTextEditorChange"))return;const e=T();e&&this.switchToProject(e)})),r().workspace.onDidChangeWorkspaceFolders((()=>this.switchToProject(this.findActiveProjectDir()))),r().commands.registerCommand("platformio-ide.rebuildProjectIndex",(()=>this._pool.getActiveObserver().rebuildIndex({force:!0}))),r().commands.registerCommand("platformio-ide.refreshProjectTasks",(()=>this._taskManager.refresh({force:!0}))),r().commands.registerCommand("platformio-ide.toggleMultiEnvProjectTasks",(()=>this._taskManager.toggleMultiEnvExplorer())),r().commands.registerCommand("platformio-ide._runProjectTask",(e=>this._taskManager.runTask(e))),r().commands.registerCommand("platformio-ide.activeEnvironment",(async()=>await this._pool.getActiveObserver().revealActiveEnvironment()))],this.internalSubscriptions=[],this.registerEnvSwitcher(),this.switchToProject(this.findActiveProjectDir(),{force:!0})}dispose(){this.disposeInternals(),h(this.internalSubscriptions),h(this.subscriptions)}findActiveProjectDir(){let e;return F.getConfiguration("activateProjectOnTextEditorChange")&&(e=T()),e||this.getSelectedProjectDir()}getSelectedProjectDir(){const e=P(),t=this._pool.getActiveProjectDir();if(e.length<1)return;if(t&&e.find((e=>e===t)))return t;const o=F.context.globalState.get("lastProjectDir");return o&&e.find((e=>e===o))?o:e[0]}saveActiveProjectState(){const e=this._pool.getActiveObserver();e&&E(e.projectDir,"selectedEnv",e.getSelectedEnv())}async switchToProject(e,t={}){if(!e)return void console.error("switchProject => Please provide project folder");let o,n;this._sbEnvSwitcher.text="$(root-folder) Loading...",this._pool.getActiveObserver()&&(o=this._pool.getActiveObserver().projectDir,n=this._pool.getActiveObserver().getSelectedEnv());const s=this._pool.getObserver(e),i=r().Uri.file(v().join(e,"platformio.ini"));try{if(!await this._configProvider.lintConfig(i))return r().window.showErrorMessage("The project configuration process has encountered an error due to a problem with the 'platformio.ini' file. Please review the file and fix the issues."),void r().window.showTextDocument(i)}catch(e){console.error(e)}"env"in t?await s.switchProjectEnv(t.env):s.getSelectedEnv()||await s.switchProjectEnv(b(e,"selectedEnv")),!t.force&&o&&o===e&&n===s.getSelectedEnv()||(h(this.internalSubscriptions),await this._pool.switch(e),this._taskManager=new H(e,s),this.internalSubscriptions.push(this._taskManager,new U(e)),0===r().window.visibleTextEditors.length&&F.getConfiguration("autoOpenPlatformIOIniFile")&&r().window.showTextDocument(r().Uri.file(v().join(e,"platformio.ini")))),r().commands.executeCommand("setContext","isTalamoProject",function(e){const t=w().readFileSync(v().join(e,"platformio.ini"),"utf8").match(/\bframework\s*=\s*([\w-]+)/);return t&&"talamo"===t[1]}(e)),this.showSelectedEnv(),this.saveActiveProjectState()}registerEnvSwitcher(){this._sbEnvSwitcher=r().window.createStatusBarItem("pio-env-switcher",r().StatusBarAlignment.Left,10),this._sbEnvSwitcher.name="Innatera: Project Environment Switcher",this._sbEnvSwitcher.tooltip="Switch  Project Environment",this._sbEnvSwitcher.command="platformio-ide.pickProjectEnv",this._sbEnvSwitcher.text="$(root-folder) Loading...",this._sbEnvSwitcher.show(),this.subscriptions.push(this._sbEnvSwitcher,r().commands.registerCommand("platformio-ide.pickProjectEnv",(()=>this.pickProjectEnv())))}showSelectedEnv(){const e=this._pool.getActiveObserver();if(!e)return;const t=e.getSelectedEnv()?`env:${e.getSelectedEnv()}`:"Default";this._sbEnvSwitcher.text=`$(root-folder) ${t} (${v().basename(e.projectDir)})`}async pickProjectEnv(){const e=[];for(const t of P()){const o=this._pool.getObserver(t),n=(await o.getConfig()).envs();if(!n||!n.length)continue;const s=`${v().basename(v().dirname(t))}/${v().basename(t)}`;e.push({projectDir:t,label:"Default",description:`$(folder) ${s} ("default_envs" from "platformio.ini")`}),e.push(...n.map((e=>({projectDir:t,env:e,label:`env:${e}`,description:`$(folder) ${s}`}))))}const t=await r().window.showQuickPick(e,{matchOnDescription:!0});t&&this.switchToProject(t.projectDir,{env:t.env,force:!0})}}class N extends i.TreeItem{constructor(e,t,o,n,s){super(e,n),t&&(this.command={title:e,command:t,arguments:o}),this.customChildren=s}}class W{getChildren(e){return e&&e.customChildren?e.customChildren:[new N("Innatera Home",void 0,void 0,i.TreeItemCollapsibleState.Expanded,[new N("Open","platformio-ide.showHome"),new N("Innatera Account","platformio-ide.showHome",["/account"]),new N("Inspect","platformio-ide.showHome",["/inspect"]),new N("Projects & Configuration","platformio-ide.showHome",["/projects"]),new N("Libraries","platformio-ide.showHome",["/libraries"]),new N("Boards","platformio-ide.showHome",["/boards"]),new N("Platforms","platformio-ide.showHome",["/platforms"]),new N("Devices","platformio-ide.showHome",["/device"])]),new N("Debug",void 0,void 0,i.TreeItemCollapsibleState.Expanded,[new N("Start Debugging","platformio-ide.startDebugging"),new N("Toggle Debug Console","workbench.debug.action.toggleRepl")]),new N("Miscellaneous",void 0,void 0,i.TreeItemCollapsibleState.Expanded,[new N("Serial & UDP Plotter","workbench.extensions.action.showExtensionsWithIds",[["alexnesnes.teleplot"]]),new N("Innatera Core CLI","platformio-ide.openPIOCoreCLI"),new N("Clone Git Project","git.clone"),new N("New Terminal","platformio-ide.newTerminal"),new N("Upgrade Innatera Core","platformio-ide.upgradeCore"),new N("Show Release Notes","platformio-ide.showReleaseNotes")])]}getTreeItem(e){return e}}const F=new class{constructor(){this.context=void 0,this.pioTerm=void 0,this.pioHome=void 0,this.projectManager=void 0,this.subscriptions=[],this._enterpriseSettings=void 0}async activate(e){this.context=e,this.pioHome=new S,this.pioTerm=new O,this.subscriptions.push(this.pioHome,this.pioTerm,new x);const t=P().length>0;console.info("PlatformIO IDE Global State",e.globalState.keys().reduce(((t,o)=>(t[o]=e.globalState.get(o),t)),{})),r().workspace.getConfiguration("extensions").has("showRecommendationsOnlyOnDemand")||r().workspace.getConfiguration("extensions").update("showRecommendationsOnlyOnDemand",!0),this.patchOSEnviron(),await this.startInstaller(!t),this.subscriptions.push(this.handleUseDevelopmentPIOCoreConfiguration()),r().commands.executeCommand("setContext","pioCoreReady",!0),"function"==typeof this.getEnterpriseSetting("onPIOCoreReady")&&await this.getEnterpriseSetting("onPIOCoreReady")(),this.subscriptions.push(r().window.registerTreeDataProvider("platformio-ide.quickAccess",new W)),this.registerGlobalCommands(),t?(r().commands.executeCommand("setContext","pioProjectReady",!0),this.subscriptions.push(new j({ignoreCommands:this.getEnterpriseSetting("ignoreToolbarCommands")})),this.initDebug(),this.projectManager=new $,this.subscriptions.push(this.projectManager),this.startPIOHome(),async function(){const e="rate-extension";let t=F.context.globalState.get(e);if(t&&t.done)return;if(t&&t.callCounter||(t={callCounter:0,done:!1}),t.callCounter+=1,t.callCounter<13)return void F.context.globalState.update(e,t);const o=await r().window.showInformationMessage("If you enjoy using Innatera IDE for VSCode, would you mind taking a moment to rate it? It will not take more than one minute. Thanks for your support!",{title:"Rate Innatera IDE Extension",isCloseAffordance:!1},{title:"Remind later",isCloseAffordance:!1},{title:"No, Thanks",isCloseAffordance:!0});switch(o?o.title:void 0){case"Rate Innatera IDE Extension":r().commands.executeCommand("vscode.open",r().Uri.parse("http://bit.ly/pio-vscode-rate")),t.done=!0;break;case"No, Thanks":t.done=!0;break;default:t.callCounter=0}F.context.globalState.update(e,t)}(),async function(){const e=r().extensions.all.filter((e=>e.isActive&&s.includes(e.id)));if(0===e.length)return;const t=await r().window.showWarningMessage(`Conflicted extensions with IntelliSense service were detected (${e.map((e=>e.packageJSON.displayName||e.id)).join(", ")}). Code-completion, linting and navigation will not work properly. Please disable or uninstall them (Menu > View > Extensions).`,{title:"More details",isCloseAffordance:!1},{title:"Uninstall conflicted",isCloseAffordance:!1},{title:"Remind later",isCloseAffordance:!0});switch(t?t.title:void 0){case"More details":r().commands.executeCommand("vscode.open",r().Uri.parse("http://bit.ly/pio-vscode-conflicted-extensions"));break;case"Uninstall conflicted":e.forEach((e=>{r().commands.executeCommand("workbench.extensions.uninstallExtension",e.id)})),r().commands.executeCommand("workbench.action.reloadWindow")}}(),this.subscriptions.push(r().window.onDidChangeActiveTextEditor((e=>async function(e){if(!e||!e.document||!e.document.fileName)return;if(!e.document.fileName.endsWith(".ino"))return;const t="ino-warn-disabled";if(F.context.globalState.get(t))return;const o=await r().window.showWarningMessage("C/C++ IntelliSense service does not support .INO files. It might lead to the spurious problems with code completion, linting, and debugging. Please convert .INO sketch into the valid .CPP file.",{title:"Show instruction",isCloseAffordance:!1},{title:"Do not show again",isCloseAffordance:!1},{title:"Remind later",isCloseAffordance:!0});switch(o?o.title:void 0){case"Show instruction":r().commands.executeCommand("vscode.open",r().Uri.parse("https://bit.ly/convert-ino-to-cpp"));break;case"Do not show again":F.context.globalState.update(t,1)}}(e))))):this.subscriptions.push(new j({filterCommands:["platformio-ide.showHome"]}))}getConfiguration(e){return r().workspace.getConfiguration("platformio-ide").get(e)}loadEnterpriseSettings(){const e=r().extensions.all.find((e=>e.id.startsWith("platformio.")&&"platformio.platformio-ide"!==e.id&&e.isActive));return e&&e.exports?e.exports.settings:void 0}getEnterpriseSetting(e,t=void 0){return this._enterpriseSettings||(this._enterpriseSettings=this.loadEnterpriseSettings()),this._enterpriseSettings&&e in this._enterpriseSettings?this._enterpriseSettings[e]:t}patchOSEnviron(){const e={PLATFORMIO_IDE:p()},t=r().workspace.getConfiguration("http").get("proxy");!t||process.env.HTTP_PROXY||process.env.http_proxy||(e.HTTP_PROXY=t),!t||process.env.HTTPS_PROXY||process.env.https_proxy||(e.HTTPS_PROXY=t),r().workspace.getConfiguration("http").get("proxyStrictSSL")||(e.PLATFORMIO_SETTING_ENABLE_PROXY_STRICT_SSL="false"),this.getConfiguration("customPyPiIndexUrl")&&(e.PIP_INDEX_URL=this.getConfiguration("customPyPiIndexUrl")),a.proc.patchOSEnviron({caller:"vscode",extraPath:this.getConfiguration("customPATH"),extraVars:e})}async startInstaller(e){const t=new y(e);if(!t.locked())return await r().window.withProgress({location:r().ProgressLocation.Window,title:"Innatera"},(async e=>{e.report({message:"Initializing Innatera Core..."});try{return!await t.check()}catch(e){}return!0}))?await r().window.withProgress({location:r().ProgressLocation.Notification,title:"Innatera Installer"},(async e=>{e.report({message:"Installing Innatera IDE..."});const o=r().window.createOutputChannel("Innatera Installation");o.show(),o.appendLine("Installing Innatera IDE..."),o.appendLine("It may take a few minutes depending on your connection speed"),o.appendLine("Please do not close this window and do not open other folders until this process is completed."),o.appendLine("\nDebugging information is available via VSCode > Help > Toggle Developer Tools > Console.");try{t.lock(),await t.install(e),o.appendLine("Innatera IDE installed successfully.\n"),o.appendLine("Please restart VSCode.");const n="Reload Now";await r().window.showInformationMessage("Innatera IDE has been successfully installed! Please reload window",n)===n&&r().commands.executeCommand("workbench.action.reloadWindow")}catch(e){o.appendLine("Failed to install Innatera IDE."),m("Installation Manager",e)}finally{t.unlock()}return t.destroy(),!0})):void 0;r().window.showInformationMessage("Innatera IDE installation has been suspended, because Innatera IDE Installer is already started in another window.")}async startPIOHome(){!this.getConfiguration("disablePIOHomeStartup")&&a.home.showAtStartup("vscode")&&r().commands.executeCommand("platformio-ide.showHome")}registerGlobalCommands(){this.subscriptions.push(r().commands.registerCommand("platformio-ide.showHome",(e=>this.pioHome.toggle(e))),r().commands.registerCommand("platformio-ide.newTerminal",(()=>this.pioTerm.new().show())),r().commands.registerCommand("platformio-ide.openPIOCoreCLI",(()=>this.pioTerm.sendText("pio --help"))),r().commands.registerCommand("platformio-ide.runPIOCoreCommand",(e=>this.pioTerm.sendText(e))),r().commands.registerCommand("platformio-ide.startDebugging",(()=>{r().commands.executeCommand("workbench.view.debug"),r().commands.executeCommand("workbench.debug.action.toggleRepl"),r().commands.executeCommand("workbench.action.debug.start")})),r().commands.registerCommand("platformio-ide.upgradeCore",(()=>this.pioTerm.sendText("pio upgrade"))))}initDebug(){c.activate(this.context)}handleUseDevelopmentPIOCoreConfiguration(){return r().workspace.onDidChangeConfiguration((async e=>{if(!e.affectsConfiguration("platformio-ide.useDevelopmentPIOCore")||!this.getConfiguration("useBuiltinPIOCore"))return;const t=a.core.getEnvDir();if(t&&I().isDirectorySync(t)){await S.shutdownAllServers(),await a.misc.sleep(2e3);try{I().removeSync(t)}catch(e){console.warn(e)}r().window.showInformationMessage("Please restart VSCode to apply the changes.")}}))}disposeLocalSubscriptions(){r().commands.executeCommand("setContext","pioCoreReady",!1),r().commands.executeCommand("setContext","pioProjectReady",!1),r().commands.executeCommand("setContext","isTalamoProject",!1),h(this.subscriptions)}deactivate(){this.disposeLocalSubscriptions()}};function V(e){return F.activate(e),F}function B(){F.deactivate(),c.deactivate()}})(),module.exports=n})();
//# sourceMappingURL=extension.js.map